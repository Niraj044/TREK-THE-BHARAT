function handleCitrusPaymentOptions(e){if(null!=e.netBanking)for(var t=0;t<e.netBanking.length;t++){var i=document.getElementById("citrusAvailableOptions"),n=document.createElement("option");n.text=e.netBanking[t].bankName,n.value=e.netBanking[t].issuerCode,i.add(n)}}function citrusServerErrorMsg(e){$("#citrusHostedFormErrorContainer").html(e),$("#citrusHostedFormErrorContainer").css("display","block"),console.log(e),$("#citrusHostedFormErrorContainer").trigger("citrusUIError"),scrollToCitrusErrorContainer(),notify_citrus_error_to_errbit(e)}function citrusClientErrMsg(e){$("#citrusHostedFormErrorContainer").html(e),$("#citrusHostedFormErrorContainer").css("display","block"),console.log(e),$("#citrusHostedFormErrorContainer").trigger("citrusUIError"),scrollToCitrusErrorContainer(),notify_citrus_error_to_errbit(e)}function scrollToCitrusErrorContainer(){$("html, body").animate({scrollTop:$("#citrusHostedFormErrorContainer").offset().top},500)}function notify_citrus_error_to_errbit(e){$.ajax({type:"POST",url:"/notify_errbit",data:{error:{message:e,url:window.location.href,browser:$.browser}}})}function PaymentStepControllerMixin(e,t,i,n,r){e.initiate_payment_via_ui=function(t){r.$broadcast("payment_submitted:"+e.selected_payment_processor.pay_id+":"+e.selected_payment_processor.id,t)},e.is_offline_payment=function(e){return!_.isEmpty(e)&&_.contains(["payments.offlinepayment","payments.payatvenue"],e)},e.fetch_payment_amount_for_pg=function(t,n){e.fetching_payment_amount=!0;var r={booking_amount:n.amount||e.booking.min_payment_required,booking_currency:e.booking.currency,pg_id:t,trip_id:e.booking.trip_id},o=i.get("/itineraries/payment_gateways/"+t+"/get_payment_amount_for_pg",{params:r});return o.success(function(t){e.payment_values_for_selected_pg=t,e.fetching_payment_amount=!1}),o},e.broadcast_pg_selected_event=function(){r.$broadcast("pg_selected:"+e.selected_payment_processor.pay_id+":"+e.selected_payment_processor.id,{payment_processor:e.selected_payment_processor,payment:e.payment})},e.$watch("payment.pg_id",function(i,n){i!=n&&_.isNumber(i)?(e.selected_payment_processor=_.find(t.payment_processors,function(t){return t.id==e.payment.pg_id}),_.isEmpty(e.selected_payment_processor)||(e.payment.payment_processor=e.selected_payment_processor.pay_id),(_.isNumber(e.payment.pg_id)||_.isString(e.payment.pg_id))&&e.fetch_payment_amount_for_pg(e.payment.pg_id,e.payment),e.broadcast_pg_selected_event()):e.selected_payment_processor=null})}function BookingMixin(e){e.get_addon_pricing_item_for=function(e){var t=this;return _.find(t.pricing_items.addons,function(t){return t.addon_id==e.id||t.pricing_rule_id==e.id})},e.get_base_pricing_item_for=function(e){var t=this;return _.find(t.pricing_items.base_pricings,function(t){return t.pricing_id==e.id||t.pricing_rule_id==e.id})},e.add_pax_pricing_item=function(e){var t={pricing_rule_id:e.id,quantity:0,name:e.name,description:e.description,rate_type:e.rate_type,rate:e.rate};return this.pricing_items.base_pricings.push(t),t},e.is_saved=function(){return!!(_.isNumber(this.id)&&this.id>0)},e.filter_pricing_items=function(){var e=Array.prototype.slice.call(arguments,0);return _.filter(this.pricing_items,function(t){return e.indexOf(t.category)>-1})},e.regenerate_pax_pricing_items=function(e){var t=this;if(e=e||{},!t.trip_option||!t.trip_option.pricings)return null;var i=[],n=_.isEmpty(t.ui.overridden_pricings)?t.trip_option.pricings:t.ui.overridden_pricings;_.each(n,function(n){i.push(n.id),_.findWhere(t.pricing_items.base_pricings,{pricing_rule_id:n.id})||t.add_pax_pricing_item(n),e.with_amounts&&console.log("from booking_mixin.js, opts.with_amounts=true is sent it. Please fix this. Currently it is just ignoring this..")}),t.pricing_items.base_pricings=_.reject(t.pricing_items.base_pricings,function(e){return!_.contains(i,e.pricing_rule_id)})},e.slab_rate_for_pax_count=function(e,t){var i=_.find(e,function(e){return e[0]>=t});return i?i[1]:null}}function DepartureSidebarMixin(e,t){e.display_departure_sidebar=function(e){var i={templateUrl:"/admin/itinerary/dashboard/departure_sidebar.html",show:!0,classes:"",extraData:{departure:e.departure,bookings:e.bookings}};t.open(i)}}!function(){var e=angular.module("vl.itinerary.store_front.bookings",["vl.common","ui","ui.router","vl.itinerary.store_front.models","ui.bootstrap","vl.itinerary.store_front.directives","vl.itinerary.common.models","vl.itinerary.common.directives","ie7-support"]);e.service("TripService",["Trip",function(e){return new e}]),e.service("TripOptionService",["TripOption",function(e){return new e}]),e.service("BookingService",["Booking","TripService","TripOptionService",function(e){return new e}]),e.service("NewPaymentService",function(){var e={update:function(t){angular.extend(e,t)}};return e}),e.factory("StorefrontLanguageInterceptor",function(){return{request:function(e){if(_.isEmpty(e.cache)){e.params=e.params||{};var t=$.deparam(window.location.search.substring(1));_.isEmpty(t.lang)||(e.params.lang=t.lang)}return e||$q.when(e)}}}),e.config(["$httpProvider",function(e){e.interceptors.push("StorefrontLanguageInterceptor")}]),e.service("InterstitialService",function(){var e={state:"idle","for":null,set_processing:function(t){"processing"!=e.state&&angular.extend(e,{state:"processing","for":t||null})},set_idle:function(){"idle"!=e.state&&angular.extend(e,{state:"idle","for":null})}};return e}),e.run(["$state","$rootScope","$stateParams","FlashMessagesService","ClientService","BookingFormSettings","BookingService","TripService","TripOptionService","NewPaymentService","InterstitialService",function(e,t,i,n,r,o,a,s,c,p,l){t.settings=o,t.interstitial_service=l,t.$state=e,t.$stateParams=i,t.userLocale={currency:s.currency},t.alerts=n,t.client=r,t.booking=a,t.trip=s,t.trip_option=c,t.payment=p,t.booking_step_class=function(t){return e.is("departure_date_step")&&"departure_date"==t||e.is("booking_items_step")&&"booking_items"==t||e.is("pax_details_step")&&"pax_details"==t||e.is("payment_step")&&"payment"==t?["active","icon-circle"]:e.is("departure_date_step")?["pending","icon-circle-blank"]:e.is("payment_step")?["complete","icon-circle"]:e.is("booking_items_step")?"departure_date"==t?["complete","icon-circle"]:["pending","icon-circle-blank"]:e.is("pax_details_step")?"payment"==t?["pending","icon-circle-blank"]:["complete","icon-circle"]:void 0}}]),angular.module("vl.itinerary.store_front.bookings").service("vlScrollService",["BookingFormSettings",function(e){return{scroll_to:function(t,i){e.booking_form_in_modal?window.top.postMessage("vl_scroll_top="+t,"*"):$("html, body").animate({scrollTop:t},i)}}}]),angular.module("vl.itinerary.store_front.bookings").service("vlFlashService",["FlashMessagesService",function(e){return e.update_errors_from_promise=function(t){e.show_errors_for_promise(t)},e}]),angular.module("vl.itinerary.store_front.bookings").directive("vlBookingFormErrorMessage",["FlashMessagesService","vlScrollService",function(e,t){return{restrict:"A",template:'<div class="booking-form-errors"><div class="alert alert-error" vl-appear="show_msg && flash.errors.length>0"><h4>{{i18n_error_message}}</h4><p ng-repeat="msg in flash.errors" ng-bind-html="msg"></p></div><div class="alert" vl-appear="show_msg && flash.notices.length>0"><p ng-repeat="msg in flash.notices" ng-bind-html="msg"></p></div></div>',scope:!0,link:function(i,n){i.show_msg=!1,i.flash=e.flash,i.flash.notices=null,i.flash.errors=null,i.i18n_error_message=VL.i18n_t("itinerary.store_front.bookings.booking_confirmation.fix_the_errors_message"),i.show_flash=function(){i.show_msg=!0,t.scroll_to(n.offset().top,1e3)},i.$on("vl:show-booking-form-errors",i.show_flash),i.$watchCollection("flash",function(){_.isEmpty(i.flash.errors)&&_.isEmpty(i.flash.notices)?i.show_msg=!1:i.show_flash()})}}}])}(),function(){var e=angular.module("vl.itinerary.store_front.bookings.post_booking_form",["vl.common","ui","ui.router","vl.itinerary.store_front.models","ui.bootstrap","vl.itinerary.store_front.directives","vl.itinerary.common.models","vl.itinerary.common.directives","ie7-support"]);angular.module("vl.itinerary.store_front.bookings.post_booking_form").service("CustomFormService",["CustomForm",function(e){return new e}]),angular.module("vl.itinerary.store_front.bookings.post_booking_form").service("vlFlashService",["FlashMessagesService",function(e){return e.update_errors_from_promise=function(t){e.show_errors_for_promise(t)},e}]),e.service("TripService",["Trip",function(e){return new e}]),e.service("PassengerService",["Passenger",function(e){return new e}]),e.service("TripOptionService",["TripOption",function(e){return new e}]),e.service("NewPaymentService",function(){var e={update:function(t){angular.extend(e,t)}};return e}),e.factory("PostCustomFormType",["$cacheFactory",function(e){return e("postCustomFormType")}]),e.service("BookingService",["Booking","TripService","TripOptionService",function(e){return new e}]),angular.module("vl.itinerary.store_front.bookings.post_booking_form").service("vlScrollService",function(){return{scroll_to:function(e,t){$("html, body").animate({scrollTop:e},t)}}}),angular.module("vl.itinerary.store_front.bookings.post_booking_form").directive("vlBookingFormErrorMessage",["FlashMessagesService","vlScrollService",function(e,t){return{restrict:"A",template:'<div class="booking-form-errors"><div class="alert alert-error" vl-appear="show_msg && flash.errors.length>0"><h4>{{i18n_error_message}}</h4><p ng-repeat="msg in flash.errors" ng-bind-html="msg"></p></div><div class="alert" vl-appear="show_msg && flash.notices.length>0"><p ng-repeat="msg in flash.notices" ng-bind-html="msg"></p></div></div>',scope:!0,link:function(i,n){i.show_msg=!1,i.flash=e.flash,i.flash.notices=null,i.flash.errors=null,i.i18n_error_message=VL.i18n_t("itinerary.store_front.bookings.post_booking_form_step.fix_the_errors_message"),i.show_flash=function(){i.show_msg=!0,t.scroll_to(n.offset().top,1e3)},i.$on("vl:show-booking-form-errors",i.show_flash),i.$watchCollection("flash",function(){_.isEmpty(i.flash.errors)&&_.isEmpty(i.flash.notices)?i.show_msg=!1:i.show_flash()})}}}])}(),angular.module("vl.itinerary.store_front.models",["ngCookies"]),angular.module("vl.itinerary.store_front.models").factory("Booking",["$http","Passenger","$q","TripOptionCache","TripOption","NewPaymentService","BookingFormSettings","TripService","TripOptionService","$timeout","DepartureDateCache",function(e,t,i,n,r,o,a,s,c,p,l){function u(e){return e-20>10?e-20:10}var d=function(e){angular.extend(this,{trip:s,trip_option:c,passengers:[],pax_count:0,guest_details:{},contacts:[{}],coupon_code:null,pricing_items:{base_pricings:[],addons:[],coupons:[]},additional_values:[],ui:{}}),angular.isDefined(e)&&this.update(e)};return d.prototype.ensure_booking=function(t){var n=this,r=i.defer();if(n.key!=t){var o=e.get("/itineraries/bookings/"+t);return o.success(function(e){s.update(e.trip),c.update(e.trip_option),n.update(e.booking),n.regenerate_pax_pricing_items(),n.regenerate_addon_pricing_items()}),o}return r.resolve({booking:n}),r.promise},d.prototype.get_pricing_items_length=function(){var e=this;return _.reduce(e.pricing_items,function(e,t){return e+t.length},0)},d.prototype.get_actual_pricing_items=function(){var e=this;return _.flatten(_.collect(e.pricing_items,function(e){return _.filter(e,function(e){return e.amount>0})}))},d.prototype.get_pricing_items=function(){var e=this;return _.flatten(_.collect(e.pricing_items,function(e){return _.filter(e,function(e){return e.quantity>0})}))},d.prototype.update=function(e){var t=this;(e=angular.copy(e)).contacts&&0==e.contacts.length&&delete e.contacts,angular.extend(this,e),angular.isString(e.starts_at)&&(this.starts_at=moment(e.starts_at)),(e.trip_id||e.pax_engagements)&&t.regenerate_addon_pricing_items(),e.trip_option_id&&t.regenerate_pax_pricing_items({with_amounts:a.pricing_breakup}),e.pricing_items&&(t.regenerate_addon_pricing_items(),t.regenerate_pax_pricing_items({with_amounts:a.pricing_breakup}),!a.pricing_breakup&&this.normalize_pricing_items()),_.isEmpty(t.pricing_items.coupons[0])&&t.pricing_items.coupons.push({coupon_code:null}),(o.amount||e.amount||e.min_payment_required||e.total_payment)&&t.update_current_payment_amount()},d.prototype.get_coupon_pricing_item=function(){return this.pricing_items.coupons[0]},d.prototype.update_current_payment_amount=function(){var e=this;o.amount?this.current_payment_amount=o.amount:e.can_skip_payment()?this.current_payment_amount=0:this.current_payment_amount=this.min_payment_required,this.balance_payment=this.amount-(this.total_payment||0)-this.current_payment_amount},d.prototype.regenerate_addon_pricing_items=function(){var e,t=this;if(!t.trip||!t.trip.addons)return null;_.each(t.trip.addons,function(i){(e=t.get_addon_pricing_item_for(i))||(e={addon_id:i.id,quantity:0},t.pricing_items.addons.push(e)),a.pricing_breakup&&(e.amount=e.amount||0)})},d.prototype.normalize_pricing_items=function(){},d.prototype.fetch_open_slot=function(){var t=this,i=t.starts_at.format("YYYY-MM-DDTHH:mm:ss");return e.get("/itineraries/trips/"+t.trip_id+"/trip_options/"+t.trip_option_id+"/fetch_open_slot.json",{params:{time_slot:i}})},d.prototype.fetch_capacity_and_pricings=function(){var e=this,t=l.get_date(e.starts_at.format("YYYY-MM-DD")),n=i.defer();if(_.isEmpty(t)){var r=e.fetch_open_slot();r.success(function(e){n.resolve({pricings:e.pricings,max_pax:e.open_slot.max_pax})}),r.error(function(){n.reject()})}else{var o=t[e.trip_option_id],a=_.find(o,function(t){return moment(t[l.avail_idx.starts_at]).format("HH:mm")==e.starts_at.format("HH:mm")});pricing_group=l.get_pricing_group(a[l.avail_idx.pricing_group_id]),n.resolve({pricings:pricing_group.pricings,max_pax:a[l.avail_idx.total_capacity]})}return n.promise},d.prototype.for_remote=function(){var e=_.omit(angular.copy(this),"trip","trip_option","properties","ui");return e.starts_at&&(e.starts_at=this.trip.time_significance?e.starts_at.format("YYYY-MM-DDTHH:mm:ss"):e.starts_at.format("YYYY-MM-DD")),e.coupon_code&&e.coupon_code.length>0&&(e.coupon_codes=[e.coupon_code]),delete e.coupon_code,e},d.prototype.serialize_me=function(){return angular.toJson(this.for_remote())},d.prototype.compute_pricing=function(){var t=this,i=e.post("/itineraries/bookings/compute_pricing.json",{booking:t.for_remote()});return i.success(function(e){t.update(_.pick(e.booking,"pricing_items","amount","min_payment_required","booking_form_alerts","confirmation_mode"))}),i},d.prototype.regenerate_pax_objects=function(e){e=e||{};var t=this;if(a.pax_info&&(e.force||!(t.passengers.length>0))){t.passengers.splice(0,t.passengers.length);var i=1;a.show_hotel_booking_form||a.show_pax_booking_form&&_.each(t.pax_engagements[0].pax_counts,function(e,n){t._create_pax_objects_for_pax_type_code(i,e,n),i+=e})}},d.prototype._create_pax_objects_for_pax_type_code=function(e,i,n){var r,o,a=e;for(r=1;r<=i;r++)o=new t({position:a,pax_type_code:n}),this.passengers.push(o),a++},d.prototype.save=function(t){t=t||{};var i=this,n=e.post("/itineraries/bookings/save",angular.extend({booking:i.for_remote()},t));return n.success(function(e){i.update(_.pick(e.booking,"key","pricing_items","starts_at","ends_at","amount","pending_payment_amount","min_payment_required","currency","booking_ref","time_significance","custom_form_values")),t.include_trip_option&&c.update(e.trip_option),i.regenerate_pax_pricing_items()}),n},d.prototype.submit_post_booking_form=function(t){var i=this;return e.post("/itineraries/bookings/post_booking_form/"+i.key,{custom_form_id:i.custom_form_id,custom_form_values:t})},d.prototype.save_step=function(t){var i=this,n=["/itineraries/bookings/save_booking_step"],r=["save",t].join("_");n.push(r);var o=e.post(n.join("/"),{booking:i.for_remote()});return o.success(function(e){i.update(_.pick(e.booking,"key","pricing_items","starts_at","ends_at","amount","pending_payment_amount","min_payment_required","currency","booking_ref","time_significance","custom_form_values","confirm_wo_payment","passengers","confirmation_mode")),e.trip_option&&c.update(e.trip_option),i.regenerate_pax_pricing_items()}),o},d.prototype._append_payment_fields=function(e,t){angular.forEach(_.omit(e,"pg_fields"),function(e,i){$('<input type="hidden"  />').attr("name","payment["+i+"]").val(e).appendTo(t)}),angular.forEach(e.pg_fields,function(e,i){$('<input type="hidden"  />').attr("name","payment[pg_fields]["+i+"]").val(e).appendTo(t)})},d.prototype.get_new_payment_relative_url=function(){return"/itineraries/bookings/"+this.key+"/new_payment"},d.prototype.get_predefined_payment_relative_url=function(e){return"/itineraries/bookings/"+this.key+"/new_payment/"+e.key},d.prototype.generate_payment_form=function(e,t){var i,n="/itineraries/bookings/"+this.key+"/new_payment";return e.key&&(n+="/"+e.key),t&&(!/^\?/.test(t)&&(n+="?"),n+=t),i=$("<form></form>").attr("action",n).attr("method","post"),this._append_payment_fields(e,i),i},d.prototype.skip_payment_form=function(e){var t="/itineraries/bookings/"+this.key+"/skip_payment";return e&&(!/^\?/.test(e)&&(t+="?"),t+=e),$("<form></form>").attr("action",t).attr("method","post")},d.prototype.inquiry_mode=function(){return"inquiry"==this.confirmation_mode},d.prototype.can_skip_payment=function(){return a.skip_payment||this.inquiry_mode()},d.prototype.cannot_skip_payment=function(){return!this.can_skip_payment()},d.prototype.addon_for=_.memoize(function(e){return _.find(this.trip.addons,function(t){return t.id==e})}),d.prototype.poll_payment=function(t,n,r){var o=this,a=1e3*(n||10),s=r||0,c=i.defer();return query_data=t.key?{payment_key:t.key}:{},e.get("/itineraries/bookings/"+o.key+"/status",{params:query_data}).success(function(e){if(!e.payment&&0==e.booking.payments.length)return p(function(){c.resolve(o.poll_payment(t,n,s+1))},a),!1;var i=e.payment?e.payment:e.booking.payments[e.booking.payments.length-1];e.payment||(e.payment=i),s>=90?(angular.extend(e,{fail_message:"timeout"}),c.reject(e)):"successful"==i.state||"failed"==i.state?("failed"==i.state&&angular.extend(e,{fail_message:"failed"}),"successful"==i.state?c.resolve(e):c.reject(e)):"processing"!=i.state&&"incomplete"!=i.state||p(function(){c.resolve(o.poll_payment(i,u(n),s+1))},a)}),d.prototype.confirmation_url=function(e){var t=["/itineraries","bookings",this.key,"confirmation"].join("/"),i=e||{};if(!_.isEmpty(i)){var n=[],r="";_.each(i,function(e,t){r=t+"="+e,n.push(r)}),t+="?"+n.join("&")}return t},d.prototype.payment_retry_url=function(e,t){var i=["/itineraries","payments",e.key,"retry_payment"].join("/"),n=t||{};if(angular.extend(n,{booking_key:this.key}),!_.isEmpty(n)){var r=[],o="";_.each(n,function(e,t){o=t+"="+e,r.push(o)}),i+="?"+r.join("&")}return i},c.promise},BookingMixin(d.prototype),d}]),angular.module("vl.itinerary.store_front.models").service("CurrencySwitcherService",["$http","$rootScope","FlashMessagesService","$cookies","ClientService","BookingService","currencySwitcherCache",function(e,t,i,n,r,o,a){function s(t,i){return e.get(c.base_url,{params:{from:t,to:i}})}angular.extend(this,{show_notice:!1,is_enabled:!1,base_url:"/exchange_rate",default_option_id:"default"});var c=this;return t.$watch(function(){return n.preferred_currency},function(e){var t=o.trip.currency,n=e;if(_.isUndefined(e)&&(n=c.default_option_id),n==c.default_option_id||n==o.trip.currency)c.is_enabled=!1,c.preferred_currency_code=c.default_option_id;else{var r=a.get_rate({from:t,to:n});if(c.is_enabled=!0,r)c.preferred_currency_code=n;else{var p=s(t,n);p.success(function(e){var t=e.exchange_rate;a.put_rate({from:t.from_currency,to:t.to_currency},t.rate),c.preferred_currency_code=n}),i.message_during_promise("Calculating amount...",p)}}}),this.convert_amount=function(e,t){var i=a.get_rate({from:t,to:n.preferred_currency});if(!angular.isUndefined(i))return e*i},this.is_default_currency=function(e){var t=["undefined",undefined,"Change currency"];return _.contains(t,e)},this}]),angular.module("vl.itinerary.store_front.models").factory("CustomFormValidation",function(){var e=function(e){var t=this;angular.extend(t,{$error:{},$invalid:!1}),e.fields&&_.each(e.fields,function(e){t.$add_field(e)})};return e.prototype.$add_field=function(e){this[e]={$error:{},$invalid:!1}},e.prototype.$add_error=function(e,t){this[e].$error[t]=!0,this[e].$invalid=!0,this.$invalid=!0},e}),angular.module("vl.itinerary.store_front.models").factory("HotelPricing",["$http",function(){var e=function(e){angular.extend(this,e)};return e.prototype.valid_guest_counts=_.memoize(function(){for(var e=[0],t=1;t<=this.max_occupancy;t++)e.push(t);return e}),e.prototype.default_occupancy=function(e){var t={};return angular.forEach(e,function(e){t[e.pax_type_code]=0}),t},e}]),angular.module("vl.itinerary.store_front.models").factory("Passenger",["$http",function(e){var t=function(e){e&&(this.update(e),angular.extend(this,{custom_form_values:[]}))};return t.prototype.update=function(e){angular.extend(this,e)},t.prototype.submit_post_booking_pax_form=function(t){var i=this;return e.post("/itineraries/bookings/post_booking_pax_form/"+i.key,{custom_form_id:i.custom_form_id,custom_form_values:t})},t}]),angular.module("vl.itinerary.store_front.models").service("PaymentHandlerService",["vlScrollService","$timeout","$q","InterstitialService",function(e,t,i,n){var r={payment_in_new_window:function(i,o,a){if(i.booking.can_skip_payment()||"payments.offlinepayment"==i.payment.payment_processor||"payments.payatvenue"==i.payment.payment_processor||!i.settings.booking_form_in_modal)a.appendTo(document.body).submit();else{var s="newPaymentWindow"+(new Date).getTime(),c=960,p=$(window).height()-.25*$(window).height(),l=$(window).width()/2,u=$(window).height()/2-p/2,_=["height="+p,"width="+c,"resizable=yes","left="+l,"top="+u,"screenX="+l,"screenY="+u,"toolbar=no","menubar=no","scrollbars=yes","location=yes","directories=no"].join(","),d=window.open("",s,_);a.attr("target",s),a.appendTo(document.body).submit(),r.poll_window(d,1e3);var m=i.booking.poll_payment(i.payment,60);n.set_processing("payments"),t(function(){e.scroll_to($(".interstitial-block").offset().top,1e3)},1e3),m.then(function(e){!d.closed&&d.close(),o&&o.resolve("Payment successful"),r.after_payment_success(e,i)},function(n){!d.closed&&d.close(),o&&o.reject("Payment failed"),r.after_payment_failure(n,i),t(function(){e.scroll_to($("div.error-block").offset().top,1e3)})})}},after_payment_success:function(e,t){var i=angular.copy(t.booking.state);t.booking.update(e.booking),angular.extend(t.payment,e.payment),opts={payment_key:t.payment.key},"confirmed"==t.booking.state&&"confirmed"!=i?opts.confirmation_message=!0:"confirmed"==t.booking.state?(opts.payment_message=!0,opts.payment_key=t.payment.key):"complete"==t.booking.state?(opts.payment_message=!0,opts.recorded_message=!0):opts.payment_message=!0;var n=t.booking.confirmation_url(opts);window.location.search.length>0&&(n+="&"+window.location.search.slice(window.location.search.indexOf("?")+1)),window.location.href=n},after_payment_failure:function(e,t){e.booking&&t.booking.update(e.booking),e.payment&&angular.extend(t.payment,e.payment),t.booking_form_mode="timeout"==e.fail_message?"connection_timeout":"payment_retry";var i=t.booking.payment_retry_url(t.payment,{mode:"timeout"==e.fail_message?"timeout":"retry",booking_form_mode:t.booking_form_mode});window.location.search.length>0&&(i+="&"+window.location.search.slice(window.location.search.indexOf("?")+1)),window.location.href=i},poll_window:function(e,n){var o=i.defer();if(window.closed||e.closed)o.resolve("Windows closed");else{try{e.VL_parent_present_at=(new Date).getTime()}catch(a){}t(function(){o.resolve(r.poll_window(e,n))},n)}}};return r}]),angular.module("vl.itinerary.store_front.models").factory("Trip",["$http",function(e){var t=function(e){this.update(e)};return t.prototype.update=function(e){angular.extend(this,e)},t.prototype.fetch_departure_calendar=function(t){return e.get("/itineraries/trips/"+this.id+"/departure_calendar.json",{params:{start:moment(t.from_dt).format("YYYY-MM-DD"),end:_.isUndefined(t.to_dt)?null:moment(t.to_dt).format("YYYY-MM-DD"),limit:_.isUndefined(t.limit)?null:t.limit,offset:_.isUndefined(t.limit)?null:t.offset}})},t.prototype.pax_types_at_trip_level=function(){if("custom_trip"==this.trip_type)return!0;if(_.contains(["short_tour","course"],this.trip_type))return!1;throw"Unknown trip type ===> "+this.trip_type},t.prototype.find_pax_type=_.memoize(function(e){return _.find(this.pax_types,function(t){return t.pax_type_code==e})}),t}]),angular.module("vl.itinerary.store_front.models").service("TripEnabledPaymentModes",["$cacheFactory",function(){return this.payment_processors=[],this}]),angular.module("vl.itinerary.store_front.models").factory("TripOption",["$http","HotelPricing",function(e,t){var i=function(e){this.update(e)};return i.prototype.update=function(e){var i=this;angular.extend(i,e),angular.forEach(i.pricing_rules,function(e,n){"hotel_pricing"!=e.pricing_type&&"package_pricing"!=e.pricing_type||(i.pricing_rules[n]=new t(e))}),angular.isDefined(i.pricing_rules)&&i.pricing_rules.length>0&&(this.per_pax_slab_pricing=_.find(this.pricing_rules,function(e){return"per_pax_pricing"==e.pricing_type&&null!=e.slabs}))},i}]),angular.module("vl.itinerary.store_front.models").factory("TripOptionCache",["$cacheFactory","$http",function(e){return e("tripOptionCache")}]),angular.module("vl.itinerary.store_front.directives",[]),angular.module("vl.itinerary.store_front.bookings").directive("vlBookingCaveatsForm",function(){return{restrict:"A",templateUrl:"booking-caveats-form.html",replace:!0,controller:"BookingCaveatsFormController"}}),angular.module("vl.itinerary.store_front.bookings").directive("vlBookingCommentsForm",function(){return{restrict:"A",templateUrl:"booking-comments-form.html",replace:!0}}),angular.module("vl.itinerary.store_front.bookings").directive("vlBookingFormErrors",["$timeout","vlScrollService",function(e,t){return{restrict:"A",scope:{errors:"="},template:'<div class="alert alert-error" vl-appear="errors.length>0" id="errors"><h4>Please fix the errors highlighed in <strong>red</strong> to continue...</h4><ul><li ng-repeat="error in errors">{{ error }}</li></ul></div>',replace:!0,link:function(i,n){i.$on("vl:show-booking-form-errors",function(){e(function(){t.scroll_to(n.offset().top,1e3)})})}}}]),angular.module("vl.itinerary.store_front.directives").directive("vlBookingReviewBlock",function(){return{restrict:"A",templateUrl:"booking-review-block.html",replace:!0,controller:["$scope",function(){}]}}),angular.module("vl.itinerary.store_front.directives").directive("vlBookingSidebar",["$state","ClientService","BookingFormSettings",function(e,t,i){return{restrict:"A",scope:{booking:"="},templateUrl:"booking-sidebar.html",replace:!0,link:function(i){i.$state=e,i.client=t},controller:["$scope","$window",function(e,t){e.settings=i,e.send_support_email=function(){var i=escape("Help with booking "+e.booking.trip.name),n=escape("My Booking ID is "+e.booking.booking_ref+" and I'm trying to book "+e.booking.trip.name+" for "+moment(e.booking.starts_at).format("D MMM, YYYY")+". Could you please help me out with _______________________________________________"),r="mailto:"+e.client.support_email+"?subject="+i+"&body="+n;t.open(r)},e.date_mismatch=function(e,t){var i=moment(e),n=moment(t);return!(i.isSame(n,"year")&&i.isSame(n,"month")&&i.isSame(n,"day"))}}]}}]),angular.module("vl.itinerary.store_front.bookings").directive("vlChildAges",["$timeout",function(){return{restrict:"A",scope:{room_eng:"=roomEngagement"},templateUrl:"child-ages.html",replace:!0,link:function(e,t){e.$watch("room_eng.occupancy.child",function(e){var i=t.closest(".controls"),n=i.find("[data-child=true]");e>0&&t.css("left",n.offset().left-i.find(".pax-type-container").offset().left)})}}}]),angular.module("vl.itinerary.store_front.bookings").directive("vlContactDetailsForm",["$timeout","ContactDetailsPrefillService",function(e,t){return{restrict:"A",templateUrl:"contact-details-form.html",replace:!0,controller:["$scope","CustomFormCache",function(e,i){e.titles=["FIXME"],e.contact_custom_form=i.get(e.trip.contact_custom_form_id),primary_contact=e.booking.contacts[0],_.defaults(primary_contact,t.cache)}]}}]),angular.module("vl.itinerary.store_front.bookings").directive("vlCurrencyChangedTooltip",["$compile","$timeout","CurrencySwitcherService","BookingService","total_amountFilter",function(e,t,i,n,r){return{restrict:"A",scope:{amount:"=",currency:"="},link:function(e,n){function o(){e.currency!=i.preferred_currency_code&&e.amount>0&&t(function(){n.popover("destroy"),n.popover({trigger:"manual",placement:"top",title:a(e.amount,e.currency)}),i.preferred_currency_code!=i.default_option_id&&n.popover("show")})}function a(e,t){return VL.i18n_t("common.store_front.themes.flexi_theme.partials.currency_tooptip_text")+" "+r(i.convert_amount(e,t),i.preferred_currency_code)}e.$watch("amount",function(){o()}),e.$watch(function(){return i.preferred_currency_code},function(){o()})}}}]),angular.module("vl.itinerary.store_front.directives").directive("vlNextStepButton",function(){return{restrict:"A",scope:{caption:"@",onClick:"&",disableButton:"@"},template:'<button type="button" ng-click="next_step()" ng-disabled="processing">{{ caption }}</button>',replace:!0,controller:["$scope",function(e){e.processing=!1,"true"==e.disableButton&&(e.processing=!0),e.next_step=function(){e.processing=!0,e.old_caption=e.caption,e.caption="Hang on...",e.onClick().then(function(){e.caption=e.old_caption,e.processing=!1},function(){e.caption=e.old_caption,e.processing=!1})},e.$on("vl:storefront:next_step_button:stop_processing",function(){e.processing=!1,e.caption=e.old_caption})}]}}),angular.module("vl.itinerary.store_front.bookings").directive("vlPaymentProcessorForm",function(){return{restrict:"A",templateUrl:"payment-processor-form.html",replace:!0,controller:"PaymentFormController"}}),angular.module("vl.itinerary.store_front.bookings").directive("vlBookingFormAlerts",function(){return{template:"<div class='ui-alerts' ng-show='alerts.messages.length>0'><div class='ui-alert' ng-repeat='alert in alerts.messages' ng-show='alerts.messages.length>0'>{{ alert.message }}</div></div>",replace:!0,scope:!0,controller:["FlashMessagesService","$scope",function(e,t){t.alerts=e}]}}),angular.module("vl.itinerary.store_front.bookings").controller("BookingCaveatsFormController",["$scope",function(e){e.$watch("caveats_checkbox",function(t){e.booking_caveats_form.caveats_checkbox.$setValidity("required",!!t)})}]),angular.module("vl.itinerary.store_front.bookings").controller("BookingItemsStepController",["$scope","$http","FlashMessagesService","$state","$stateParams","DepartureDateCache","BookingService","TripOptionCache","TripOption","$timeout","Passenger","$q","CustomFormValidation","vlFlashService","TripOptionService","vlScrollService","PaymentHandlerService","makeRangeFilter","line_item_amountFilter","CustomFormCache","TripEnabledPaymentModes","$injector","$rootScope","ContactDetailsPrefillService",function(e,t,i,n,r,o,a,s,c,p,l,u,d,m,g,f,h,v,y,b,k,w){function x(e){_.each(e,function(t,i){delete e[i]})}e.coupon_codes_applicable=!0;var S={};try{S=w.get("openSlotResolve")}catch(F){S={}}_.isEmpty(S)?a.fetch_capacity_and_pricings().then(function(t){e.booking.ui.overridden_pricings=t.pricings,e.booking.regenerate_pax_pricing_items(),e.trip_option.max_pax=t.max_pax,e.trip_option.pricings=t.pricings}):(e.booking.ui.overridden_pricings=S.pricings,e.booking.regenerate_pax_pricing_items(),e.trip_option.max_pax=S.max_pax,e.trip_option.pricings=S.pricings),e.recompute_pricing=function(){e.computing_price?D=!0:(C=a.compute_pricing(),e.computing_price=!0,m.clear_all(),i.message_during_promise("Calculating total price...",C),m.update_errors_from_promise(C),C.success(function(e){_.isEmpty(e.booking.booking_form_alerts)||m.add_notices(e.booking.booking_form_alerts,{clear:!1})}),C.then(function(){e.settings.pricing_breakup&&e.add_amounts_to_coupon_items(),e.after_recompute_pricing()},e.after_recompute_pricing))},e.after_recompute_pricing=function(){e.computing_price=!1,e.coupon_codes_applicable=!!_.isEmpty(e.coupon_code),D&&(D=!1,e.recompute_pricing())},e.add_amounts_to_coupon_items=function(){var t=e.booking.get_coupon_pricing_item();e.coupon_amount=t?t.amount:null},e.addon_quantity_changed=function(){e.recompute_pricing()},e.coupon_code_applied=function(){var t=e.booking.get_coupon_pricing_item();if(x(t),t.coupon_code=e.coupon_code,e.validate_booking_items(),e.bi_form.$invalid)return!1;e.recompute_pricing()},e.coupon_code_removed=function(){var t=e.booking.get_coupon_pricing_item();x(t),t.coupon_code=null,e.coupon_code=null,e.coupon_codes_applicable=!0,e.recompute_pricing()},e.next_step=function(){e.validate_booking_items();var t=u.defer()
;if(e.$broadcast("custom_form_generator:submit"),e.bi_form.$invalid||e.booking_items_form.$invalid||!_.isEmpty(m.errors))return e.show_errors=!0,t.resolve(),t.promise;m.clear_all();var i=a.save_step("booking_items_step");return m.update_errors_from_promise(i),i.success(function(){t.resolve(),e.settings.pax_info?n.transitionTo("pax_details_step",{booking_key:a.key}):n.transitionTo("payment_step",{booking_key:a.key})}),i},e.base_pricing_item_for=function(t){return e.booking.get_base_pricing_item_for(t)},e.addon_pricing_item_for=function(t){return e.booking.get_addon_pricing_item_for(t)},e.validate_passenger_form=function(){0==_.reduce(a.pricing_items.base_pricings,function(e,t){return _.isEmpty(t.category)||"per_pax"==t.category?e+t.quantity:e},0)&&e.bi_form.$add_error("guest_count","min")},e.validate_booking_items=function(){e.show_errors=!1,e.bi_form=new d({fields:["guest_count"]}),e.settings.show_pax_booking_form&&e.validate_passenger_form(),(e.bi_form.$invalid||e.booking_items_form.$invalid||!_.isEmpty(m.errors))&&p(function(){_.isEmpty(m.errors)?f.scroll_to($(".booking-form-errors").offset().top-20,1e3):f.scroll_to($("div[vl-booking-form-error-message]").offset().top-20,1e3)})},e.computing_price=!1,e.show_errors=!1,e.coupon_code=null,e.$watch("booking.pricing_items.coupons[0]",function(t,i){t!=i&&(e.booking.pricing_items.coupons[0].booking_item_ref?e.coupon_code=e.booking.pricing_items.coupons[0].booking_item_ref:e.coupon_code=e.booking.pricing_items.coupons[0].coupon_code)});var C=null,D=!1;e.booking_custom_form=b.get(e.trip.booking_custom_form_id),f.scroll_to(0)}]),angular.module("vl.itinerary.store_front.bookings").controller("ConfirmationStepController",["$scope","FlashMessagesService","$state","$stateParams","BookingService",function(){}]),angular.module("vl.itinerary.store_front.bookings").controller("ContactFormController",["$scope",function(){}]),angular.module("vl.itinerary.store_front.bookings").controller("DepartureDateStepController",["$scope","$state","$stateParams","DepartureDateCache","BookingService","TripOptionCache","TripOption","vlFlashService","TripOptionService","vlScrollService","$timeout",function(e,t,i,n,r,o,a,s,c,p,l){e.occurrence_guaranteed=function(e){return e.available_seats>0},e.pagination_change=function(t,i){return e.fetch_upcoming_departures(e.ui.current_departure_month,e.ui.current_departure_year,t,i).then(function(){e.ui.departure_offset=i})},e.select_departure_date=function(t){e.filtered_trip_options=_.reduce(n.get_date(t),function(e,t,i){var r=_.reduce(t,function(e,t){return t!=Infinity&&e.push({min_pax:t[n.avail_idx.min_pax],available_seats:t[n.avail_idx.available_seats],total_capacity:t[n.avail_idx.total_capacity],booked_seats:t[n.avail_idx.total_capacity]-t[n.avail_idx.available_seats],starts_at:t[n.avail_idx.starts_at],ends_at:t[n.avail_idx.ends_at],pricing_group:n.get_pricing_group(t[n.avail_idx.pricing_group_id])}),e},[]),a=_.min(_.collect(r,function(e){return e.pricing_group.sticker_price}));return e.push({trip_option_id:i,trip_option:o.get(i),time_slots:r,sticker_price:a}),e},[]),e.filtered_trip_options=_.sortBy(e.filtered_trip_options,function(e){return e.trip_option.position}),l(function(){var e=$(".trip-option-list button:first"),t=$(".trip-option-list button");e.offset().top>$(window).height()&&p.scroll_to(t.offset().top-20,500)})},e.fetch_upcoming_departures=function(t,i,r,o){e.ui.show_spinner=!0;var a=e.trip.fetch_departure_calendar({from_dt:moment().month(t).year(i).startOf("month"),limit:r,offset:o});return s.message_during_promise("Fetching available dates & options...",a),s.update_errors_from_promise(a),a.success(function(t){n.load(t.departure_calendar.availability.data,t.departure_calendar.availability_keys),n.load_pricings(t.departure_calendar.pricings),e.departure_list_refresh++,e.ui.show_spinner=!1}),a.error(function(){e.ui.show_spinner=!1}),a},e.fetch_departure_calendar=function(t,i){if(!n.get_month(t,i)){var r=moment([t,i-1,1]),o=r.clone().add("months",1).startOf("month"),a=e.trip.fetch_departure_calendar({from_dt:r,to_dt:o});return s.message_during_promise("Fetching available dates & trip options...",a),s.update_errors_from_promise(a),a.success(function(r){n.load(r.departure_calendar.availability.data,r.departure_calendar.availability_keys),n.load_pricings(r.departure_calendar.pricings),n.put_month(t,i,!0),e.calendar_refresh++}),a}},e.trip_option_selected=function(i,n,o){e.processing=!0,c.update(i),r.ui.overridden_pricings=o,r.update({trip_option_id:i.id,starts_at:moment(n),trip_option:i});var a=r.save_step("dep_date_step");return s.clear_all(),s.message_during_promise("Fetching booking form...",a),s.update_errors_from_promise(a),a.success(function(){t.transitionTo("booking_items_step",{booking_key:r.key})}),a.success(function(){e.processing=!1}).error(function(){e.processing=!1}),a},e.filtered_trip_options=[];var u=e.settings.preselected_departure_date?moment(e.settings.preselected_departure_date):null;e.selected_date=null,u&&n.get_date(u)&&(e.selected_date=u,e.select_departure_date(e.selected_date)),e.calendar_refresh=1,e.departure_list_refresh=1,e.ui={current_departure_month:moment().month(),current_departure_year:moment().year(),departure_limit:e.trip.booking_form_ui_settings.departure_list_limit,departure_offset:0,show_spinner:!1,show_trip_option_details:o.info().size>1},e.fetch_departure_calendar(moment().year(),moment().month()+1),p.scroll_to(0),e.$watch("ui.current_departure_month",function(t,i){0==e.ui.departure_offset&&t!=i?e.fetch_upcoming_departures(e.ui.current_departure_month,e.ui.current_departure_year,e.ui.departure_limit,e.ui.departure_offset):e.ui.departure_offset=0}),e.$watch("filtered_trip_options",function(t){_.isUndefined(t)||(e.show_accordions=e.trip.time_significance)})}]),angular.module("vl.itinerary.store_front.bookings").controller("PaxDetailsStepController",["$scope","FlashMessagesService","$state","$stateParams","DepartureDateCache","BookingService","TripOptionCache","TripOption","$timeout","Passenger","$q","$http","vlFlashService","vlScrollService","CustomFormCache",function(e,t,i,n,r,o,a,s,c,p,l,u,_,d,m){e.errors=[],e.titles=["FIXME"],e.pax_custom_form=m.get(e.trip.pax_custom_form_id);var g=o.ensure_booking(n.booking_key);t.message_during_promise("Fetching booking details...",g),d.scroll_to(0),e.next_step=function(){var n=l.defer();if(e.$broadcast("custom_form_generator:submit"),e.pax_details_form.$invalid)return e.show_errors=!0,e.$broadcast("vl:show-booking-form-errors"),n.resolve(),n.promise;e.show_errors=!1;var r=o.save_step("pax_details_step");return t.message_during_promise("Saving participant details...",r),_.update_errors_from_promise(r),r.success(function(){i.transitionTo("payment_step",{booking_key:o.key})}),r}}]),angular.module("vl.itinerary.store_front.bookings").controller("PaymentFormController",["$scope","BookingFormSettings","TripEnabledPaymentModes","$timeout","vlScrollService",function(e,t,i,n,r){function o(){return document.documentElement.clientWidth}function a(){e.is_desktop()||n(function(){r.scroll_to($(".selected-pg").offset().top,500)})}angular.isUndefined(e.payment.pg_fields)&&(e.payment.pg_fields={}),e.pg_fields=e.payment.pg_fields,e.is_desktop=function(){return o()>=980},e.toggle_pg_selection=function(t,i){e.payment.pg_id==t?e.deselect_selected_pg():(e.payment.pg_id=t,i&&a())},e.deselect_selected_pg=function(){e.payment.pg_id=null}}]),angular.module("vl.itinerary.store_front.bookings").controller("PaymentStepController",["$scope","$http","FlashMessagesService","$state","$stateParams","DepartureDateCache","BookingService","TripOptionCache","TripOption","$timeout","Passenger","NewPaymentService","$q","vlScrollService","PaymentHandlerService","BookingFormSettings","TripEnabledPaymentModes","$rootScope",function(e,t,i,n,r,o,a,s,c,p,l,u,d,m,g,f,h,v){function y(e){var t={payment:{pg_fields:{}}};return _.each(_.omit(e,"pg_fields"),function(e,i){t.payment[i]=e}),_.each(e.pg_fields,function(e,i){var n=["citrusCardHolder","citrusCardType","citrusNumber","citrusExpiry","citrusCvv"];_.contains(n,i)||(t.payment.pg_fields[i]=e)}),t}m.scroll_to(0),e.payment={},e.fetching_payment_amount=!1,_.isEmpty(u)||angular.extend(e.payment,u),e.caveats_checkbox=!1,e.errors=[],e.show_errors=!1,e.next_step=function(){var i=d.defer();if(e.confirmation_step_form.$invalid)return e.show_errors=!0,m.scroll_to($(".booking-form-errors").offset().top-20,1e3),i.reject("Form is invalid"),i.promise;e.show_errors=!1;var n,r=a.can_skip_payment()&&!f.payment_request;if(r||"ui"!=e.selected_payment_processor.initiate_payment_via)return n=r?a.skip_payment_form(window.location.search):a.generate_payment_form(e.payment,window.location.search),e.processing=!0,g.payment_in_new_window(e,i,n),i.promise.then(function(){e.processing=!1},function(){e.processing=!1}),i.promise;if(f.payment_request)var o=t.post(a.get_predefined_payment_relative_url(e.payment),y(e.payment));else o=t.post(a.get_new_payment_relative_url(),y(e.payment));return o.success(function(t){e.initiate_payment_via_ui(t),i.resolve()}),o.error(function(){i.reject()}),i.promise},PaymentStepControllerMixin(e,h,t,p,v)}]),angular.module("vl.itinerary.store_front.bookings.post_booking_form").controller("PostBookingFormController",["$scope","FlashMessagesService","$state","$stateParams","PassengerService","vlFlashService","vlScrollService","BookingService","CustomFormCache","PostCustomFormType","$q",function(e,t,i,n,r,o,a,s,c,p,l){e.errors=[],e.booking=s,e.passenger=r,e.post_custom_form_type=p.get("form_type"),"post_booking_form"==e.post_custom_form_type?(e.custom_form=c.get(e.booking.custom_form_id),e.custom_from_values=e.booking.custom_form_values):"post_booking_pax_form"==e.post_custom_form_type&&(e.custom_form=c.get(e.passenger.custom_form_id),e.custom_from_values=e.passenger.custom_form_values),a.scroll_to(0),e.submit_form=function(){var n,a=l.defer();return e.$broadcast("custom_form_generator:submit"),e.post_booking_form.$invalid?(e.show_errors=!0,e.$broadcast("vl:show-booking-form-errors"),a.resolve(),a.promise):(e.show_errors=!1,"post_booking_form"==e.post_custom_form_type&&(n=s.submit_post_booking_form(e.custom_from_values)),"post_booking_pax_form"==e.post_custom_form_type&&(n=r.submit_post_booking_pax_form(e.custom_from_values)),t.message_during_promise("Submitting form details...",n),o.update_errors_from_promise(n),n.success(function(){i.transitionTo("post_booking_form_submitted")}),n)}}]),angular.module("vl.itinerary.common.models",[]),angular.module("vl.itinerary.common.models").factory("DepartureDateCache",["$cacheFactory",function(e){var t=e("departureDateCache");return t.min_date_string=null,t.max_date_string=null,t.dates=[],t.pricings={},t.month_key=function(e,t){return"month-"+e+"-"+t},t.get_date=function(e){return this.get(e.hasOwnProperty("_d")?e.format("YYYY-MM-DD"):e)},t.put_date=function(e,t){return(!this.min_date_string||e<this.min_date_string)&&(this.min_date_string=e),(!this.max_date_string||e>this.max_date_string)&&(this.max_date_string=e),this.dates.push(e),this.dates.sort(),this.put(e,t)},t.get_month=function(e,t){return this.get(this.month_key(e,t))},t.put_month=function(e,t,i){return this.put(this.month_key(e,t),i)},t.load=function(e,t){var i=this;i.dates=[],i.avail_idx=_.reduce(t,function(e,t,i){return e[t]=i,e},{}),_.each(e,function(e,t){i.put_date(t,angular.copy(e))})},t.load_pricings=function(e){_.extend(this.pricings,e)},t.get_pricing_group=function(e){return this.pricings[e]},t.removeAll=_.wrap(t.removeAll,function(e){e(),this.min_date_string=null,this.max_date_string=null}),t}]),angular.module("vl.itinerary.common.directives",[]),angular.module("vl.itinerary.common.directives").directive("vlAvailabilityBlock",[function(){return{restrict:"A",scope:{occurrence:"=",ui_settings:"=uiSettings"},replace:!0,templateUrl:"/store_front/itinerary/bookings/availability-block.html",controller:["$scope",function(e){e.$watch("occurrence",function(t){if(angular.isDefined(t)){e.urgency_trigger_condition=null;var i=e.ui_settings.urgency_triggers;angular.isDefined(i[0])&&t.available_seats<=i[0].seats_less_than_equal?e.urgency_trigger_condition=i[0].name:angular.isDefined(i[1])&&t.available_seats<=i[1].seats_less_than_equal?e.urgency_trigger_condition=i[1].name:angular.isDefined(i[2])&&t.available_seats<=i[2].seats_less_than_equal?e.urgency_trigger_condition=i[2].name:angular.isDefined(i[3])&&t.available_seats<=i[3].seats_less_than_equal&&(e.urgency_trigger_condition=i[3].name)}})}]}}]),angular.module("vl.itinerary.common.directives").directive("vlItineraryDepartureMonthSelector",["$filter",function(){return{restrict:"A",scope:!0,replace:!0,template:'<select class="dep-month-selector" ng-model="dep_mnth_yr" ng-options="dep_mnth_yr as dep_mnth_yr.desc for dep_mnth_yr in dt_yr_combos"></select>',controller:["$scope","$filter",function(e,t){function i(e,i){return{month:e,year:i,desc:t("date")(new Date(i,e),"MMMM - yyyy")}}var n=moment().startOf("month").month(),r=moment().year();e.dt_yr_combos=[i(n,r)];for(var o=n+1,a=r;n!=o;)e.dt_yr_combos.push(i(o,a)),o>=11?(o=0,a=moment().year(a).startOf("month").add(1,"years").year()):o+=1;e.months=moment.months(),e.dep_mnth_yr=_.find(e.dt_yr_combos,function(t){return t.month==e.ui.current_departure_month&&t.year==e.ui.current_departure_year}),e.$watch("dep_mnth_yr",function(t){angular.extend(e.ui,{current_departure_month:t.month,current_departure_year:t.year})}),e.$watch("ui",function(){e.dep_mnth_yr=_.find(e.dt_yr_combos,function(t){return t.month==e.ui.current_departure_month&&t.year==e.ui.current_departure_year})},!0)}]}}]),angular.module("vl.itinerary.common.directives").directive("vlItineraryDepartureDatePicker",["DepartureDateCache","$timeout","ClientService","availability_classFilter","$q",function(e,t,i,n,r){return{restrict:"A",scope:{departureDate:"=",disableTranslation:"=",onChange:"&",onChangeMonthYear:"&",refresh:"=",openPicker:"=",settings:"=",maxDate:"@"},link:function(i,o){t(function(){var a=new Date,s='<ul class="legend"><li class="open-date available"><i></i> '+VL.i18n_t("itinerary.store_front.booking_calendar.available")+'</li><li class="open-date filling-fast"><i></i> '+VL.i18n_t("itinerary.store_front.booking_calendar.filling_fast")+'</li><li class="closed-date sold-out"><i></i> '+VL.i18n_t("itinerary.store_front.booking_calendar.sold_out")+'</li><li class="closed-date not-operating"><i></i> '+VL.i18n_t("itinerary.store_front.booking_calendar.not_operating")+"</li></ul>";o.addClass("vl-departure-date-picker");var c={allow_sold_out_bookings:!1,allow_not_operating_bookings:!1};angular.extend(c,i.settings),o.datepicker({minDate:a,maxDate:i.maxDate?moment(i.maxDate).toDate():undefined,nextText:"&rarr;",prevText:"&larr;",firstDay:1,dateFormat:"yy-mm-dd",onSelect:function(e){var t=moment(e);i.departureDate&&t.isSame(i.departureDate)||i.$apply(function(){i.departureDate=t,i.onChange({mDate:t})})},beforeShowDay:function(t){var i=moment(t),r=e.get_date(i);if(_.isEmpty(r))return[c.allow_not_operating_bookings,"not-operating"];var o=_.values(r),a=0,s=0;_.each(o,function(t){t.forEach(function(t){a+=t[e.avail_idx.available_seats],s+=t[e.avail_idx.total_capacity]})});var p=n(a,s),l=!0;return"sold-out"==p&&(l=c.allow_sold_out_bookings),[l,p]},onChangeMonthYear:function(e,n){i.old_details={},i.$apply(function(){var a=i.onChangeMonthYear({year:e,month:n});t(function(){var e=o.find(".ui-datepicker-header"),t=e.find(".ui-datepicker-title .ui-datepicker-month"),n=e.find(".ui-datepicker-title .ui-datepicker-year");i.old_details=p(e,t,n),r.when(a,function(){l(e,t,n,i.old_details.old_month,i.old_details.old_year)})})})},onClose:function(){i.$apply(function(){i.openPicker=!1})},defaultDate:e.min_date_string?moment(e.min_date_string).toDate():undefined}),url_params=$.deparam(window.location.search.substring(1)),_.isEmpty(url_params.lang)||_.isEmpty($.datepicker.regional[url_params.lang])?$.datepicker.setDefaults($.datepicker.regional[""]):$.datepicker.setDefaults($.datepicker.regional[url_params.lang]),o.after(s),i.disableTranslation&&$(".ui-datepicker-inline").addClass("notranslate");var p=function(e,t,i){e.find(".ui-datepicker-title .ui-datepicker-prev"),e.find(".ui-datepicker-title .ui-datepicker-next");var n={old_month:t.text(),old_year:i.text()};return t.html("Loading"),i.html('<img src="/assets/ajax-loader.gif">'),e.find(".ui-datepicker-prev, .ui-datepicker-next").hide(),n},l=function(e,t,i,n,r){t.html(n),i.html(r),e.find(".ui-datepicker-prev, .ui-datepicker-next").show()};i.$watch("refresh",function(){o.datepicker("refresh")}),i.$watch("openPicker",function(t,n){!t==n&&(i.setDefaultDate(e.min_date_string),t?o.datepicker("show"):o.datepicker("hide"))}),i.$watch("departureDate",function(e){e!==undefined&&null!=e&&o.datepicker("setDate",e.format("YYYY-MM-DD"))}),i.setDefaultDate=function(e){e&&o.datepicker("option","defaultDate",e)}})}}}]),angular.module("vl.itinerary.common.directives").directive("vlItineraryDepartureDatepickerV2",["DepartureDateCache","$timeout","ClientService",function(e){return{restrict:"A",scope:{trip_id:"=tripId",booking:"=",onSelect:"&"},replace:!0,templateUrl:"/admin/itinerary/bookings/departure-datepicker-v2.html",link:function(){},controller:["$scope","$http","Trip",function(t,i,n){function r(i,n,r){t.ui.topt_idx=i,t.ui.slot_idx=n,t.ui.topt=t.trip.trip_options[i],t.ui.dt=r,_.isEmpty(e.get_date(r))?t.ui.slot=undefined:t.ui.slot=e.get_date(r)[t.ui.topt.id][n]}t.edit_selection=function(){t.ui.state="edit"},t.date_selected=function(e){t.ui.dt=e.hasOwnProperty("_d")?e.format("YYYY-MM-DD"):e},t.fetch_trip=function(n){n=_.isEmpty(n)?{}:n,t.ui.show_spinner=!0;var r=_.isEmpty(n.avail_month)?moment().startOf("day"):n.avail_month,o={include_availability_between_start:r.format("YYYY-MM-DD"),"keys[]":"confirmation_email_content"};"list"==t.ui.dp_mode?(o.include_availability_limit=t.ui.availability_limit,o.include_availability_offset=t.ui.availability_offset*t.ui.availability_limit):o.include_availability_between_end=r.clone().add("months",1).startOf("month").format("YYYY-MM-DD");var a=i.get("/admin/trips/"+t.trip.id,{params:o});return a.success(function(i){t.trip.update(i.trip),t.trip.availability=i.availability.data,t.ui.dates=_.keys(t.trip.availability),t.ui.dt=t.ui.dates[0],e.load(t.trip.availability,i.availability_keys),e.load_pricings(i.pricings),t.ui.avail_idx=e.avail_idx,t.ui.calendar_refresh+=1,t.ui.show_spinner=!1,t.booking.update({trip_id:t.trip.id,time_significance:t.trip.time_significance,currency:t.trip.currency})}),a},t.enter_pressed=function(){t.booking.trip_id=t.trip.id,t.booking.trip_option_id=t.ui.topt.id,t.booking.pricing_group_id=t.ui.topt.pricing_group_id,t.booking.pricings=t.ui.topt.pricings,t.booking.starts_at=_.isUndefined(t.ui.slot)?moment(t.ui.dt):moment(t.ui.slot[t.ui.avail_idx.starts_at]),t.ui.state="view",_.isUndefined(t.ui.slot)&&t.trip.time_significance?(t.ui.booking_start_time=t.booking.starts_at.format("HH:mm"),t.ui.show_start_time_selector=!0):(t.booking.pricing_group_id=t.ui.slot[e.avail_idx.pricing_group_id],t.booking.ui.overridden_pricings=e.get_pricing_group(t.ui.slot[e.avail_idx.pricing_group_id]).pricings,t.ui.booking_start_time=null,t.ui.show_start_time_selector=!1,t.onSelect())},t.time_slot_selected=function(){var e=parseInt(t.ui.booking_start_time.split(":")[0]),i=parseInt(t.ui.booking_start_time.split(":")[1]);t.booking.starts_at=t.booking.starts_at.add(e,"hours").add(i,"minutes"),t.onSelect()},t.month_changed=function(i,n){var r=n-1;if(n<=moment().month()&&moment().year()==i)var o=moment().startOf("day");else o=moment().months(r).year(i).startOf("month");var a=e.get_month(i,n);if(_.isEmpty(a))return t.fetch_trip({avail_month:o}).success(function(){e.put_month(i,n,t.trip.availability)});t.trip.availability=a,t.ui.dt=_.keys(a)[0]},t.prev_upcoming_departures=function(){t.ui.availability_offset-=1,t.ui.availability_offset<0&&(t.ui.availability_offset=0),t.fetch_trip()},t.next_upcoming_departures=function(){t.ui.availability_offset+=1,t.fetch_trip()},t.select_slot=function(e,i,n){return r(e,i,n),t.enter_pressed()},t.ui={dp_mode:"cal",state:"view",dt:null,dates:[],avail_idx:{},slot_idx:null,topt_idx:null,topt:null,slot:null,booking_start_time:null,show_spinner:!1,calendar_refresh:0,availability_limit:10,availability_offset:0},t.$watch("ui.dp_mode",function(i,n){i!=n&&(e.removeAll(),t.trip.availability=null,t.fetch_trip())}),t.$watch("trip_id",function(i,r){_.isUndefined(i)||i==r||(t.trip=new n({id:i}),e.removeAll(),t.fetch_trip().success(function(){t.edit_selection(),t.ui.state="edit"}))})}]}}]),angular.module("vl.itinerary.common.directives").directive("vlItineraryDepartureListFooter",function(){return{restrict:"A",scope:!0,replace:!0,template:'<div class="list-footer"><div class="inner-block"><div class="spinner" ng-show="ui.show_spinner"><img src="/assets/ajax-loader.gif"></div><div vl-simple-pagination offset="ui.departure_offset" limit="ui.departure_limit" on-next="pagination_change(limit, offset)" on-prev="pagination_change(limit, offset)"></div></div></div>',controller:["$scope",function(){}]}}),angular.module("vl.itinerary.common.directives").directive("vlItineraryDepartureListHeader",["DepartureDateCache","$timeout",function(){return{restrict:"A",scope:!0,replace:!0,templateUrl:"/store_front/itinerary/bookings/departure-list-header.html",controller:["$scope","UIFilters",function(e,t){e.ui_filters=t}]}}]),angular.module("vl.itinerary.common.directives").directive("vlItineraryDepartureListHeaderMulti",["DepartureDateCache","$timeout",function(){return{restrict:"A",scope:!0,replace:!0,templateUrl:"/store_front/itinerary/bookings/departure-list-header-multi.html",controller:["$scope","UIFilters","TripCache","TripFilters","UISettings","TripIds",function(e,t,i,n,r,o){e.ui_filters=t,e.TripIds=o,e.select_trip=function(e){_.isEmpty(e)?t.trip_id="":t.trip_id=e.id},e.widget_trips=[],angular.forEach(o,function(t){e.widget_trips.push({id:t,name:i.get(t).name})}),e.$watch("ui_filters['trip_id']",function(i){_.isEmpty(i)?e.selected_trip=null:e.selected_trip=_.find(e.widget_trips,function(e){return e.id==t.trip_id})})}]}}]),angular.module("vl.itinerary.common.directives").directive("vlItineraryDepartureListItem",["DepartureDateCache","$timeout",function(e,t){return{restrict:"A",scope:!0,replace:!0,templateUrl:"/store_front/itinerary/bookings/departure-list-item.html",link:function(e,i){t(function(){i.find(".variant-info").popover({title:e.occ.trip_option.title,content:e.occ.trip_option.description,placement:"right",toggle:"popover",trigger:"manual"})}),e.toggle_variant_info=function(){if(window.innerWidth<768)i.find(".variant-info-block").toggle({duration:200});else{var e=i.find(".variant-info");i.parentsUntil(".widget-container").find(".variant-info").not(e).popover("hide"),e.popover("toggle")}}},controller:["$scope",function(e){e.date_mismatch=function(e,t){return!(e.isSame(t,"year")&&e.isSame(t,"month")&&e.isSame(t,"day"))}}]}}]),angular.module("vl.itinerary.common.directives").directive("vlItineraryDepartureListItemMulti",["$timeout",function(e){return{restrict:"A",scope:!0,replace:!0,templateUrl:"/store_front/itinerary/bookings/departure-list-item-multi.html",link:function(t,i){e(function(){i.find(".variant-info").popover({title:t.occ.trip_option.title,content:t.occ.trip_option.description,placement:"right",toggle:"popover",trigger:"manual"})}),t.toggle_variant_info=function(){if(window.innerWidth<768)i.find(".variant-info-block").toggle({duration:200});else{var e=i.find(".variant-info");i.parentsUntil(".widget-container").find(".variant-info").not(e).popover("hide"),e.popover("toggle")}}},controller:["$scope",function(e){e.date_mismatch=function(e,t){return!(e.isSame(t,"year")&&e.isSame(t,"month")&&e.isSame(t,"day"))},e.same_day_departure=function(t,i){return!e.date_mismatch(t,i)}}]}}]),angular.module("vl.itinerary.common.directives").directive("vlItineraryDepartureListView",["DepartureDateCache","$timeout","TripOption",function(e){return{restrict:"A",scope:{trip:"=",onSelect:"&",ui_settings:"=uiSettings",refresh:"="},replace:!0,templateUrl:"/store_front/itinerary/bookings/departure-list-view.html",controller:["$scope","$http","Trip","TripOptionCache",function(t,i,n,r){t.book_now_clicked=function(e,i,n,r){return t.onSelect({trip:e,trip_option:i,pricings:r,starts_at:n})},t.occurrence_guaranteed=function(e){return 0!=e.available_seats},t.construct_disp_obj=function(){t.events=[],_.each(e.dates,function(i){var n=e.get_date(i),o={date:moment(i),occurrences:[],multiple_occurrences:!1};_.each(n,function(t,i){_.each(t,function(t){o.occurrences.push({trip_option:r.get(i),starts_at:moment(t[e.avail_idx.starts_at]),ends_at:moment(t[e.avail_idx.ends_at]),available_seats:t[e.avail_idx.available_seats],total_capacity:t[e.avail_idx.total_capacity],booked_seats:t[e.avail_idx.total_capacity]-t[e.avail_idx.available_seats],min_pax:t[e.avail_idx.min_pax],pricing_group:e.get_pricing_group(t[e.avail_idx.pricing_group_id])})})}),o.multiple_occurrences=o.occurrences.length>1,t.events.push(o)})},t.construct_disp_obj(),t.$watch("refresh",function(e){1!=e&&t.construct_disp_obj()})}]}}]),angular.module("vl.itinerary.common.directives").directive("vlItineraryDepartureListViewMulti",["$timeout",function(){return{restrict:"A",scope:{trips:"=",onSelect:"&",ui_settings:"=uiSettings",refresh:"="},replace:!0,templateUrl:"/store_front/itinerary/bookings/departure-list-view-multi.html",controller:["$scope","$http","TripCache","TripOptionCache","AvailabilityDataService",function(e,t,i,n,r){e.book_now_clicked=function(t,i,n,r){return e.onSelect({trip:t,trip_option:i,pricings:r,starts_at:n})},e.occurrence_guaranteed=function(e){return 0!=e.available_seats},e.construct_disp_obj=function(){e.events=[],_.each(r.availability,function(t){_.each(t.data,function(o,a){var s=_.find(e.events,function(e){return e.dt_str==a}),c=!1;_.isEmpty(s)&&(s={dt_str:a,date:moment(a),occurrences:[],multiple_occurrences:!1},c=!0),_.each(o,function(e,o){_.each(e,function(e){s.occurrences.push({trip_id:t.trip_id,trip:i.get(t.trip_id),trip_option:n.get(o),starts_at:moment(e[r.avail_idx.starts_at]),ends_at:moment(e[r.avail_idx.ends_at]),available_seats:e[r.avail_idx.available_seats],total_capacity:e[r.avail_idx.total_capacity],booked_seats:e[r.avail_idx.total_capacity]-e[r.avail_idx.available_seats],min_pax:e[r.avail_idx.min_pax],pricing_group:r.get_pricing_group(e[r.avail_idx.pricing_group_id])})})}),s.multiple_occurrences=s.occurrences.length>1,c&&e.events.push(s)})})},e.construct_disp_obj(),e.$on("availability_data:refresh",function(){e.construct_disp_obj()})}]}}]),angular.module("vl.itinerary.common.directives").directive("durationView",[function(){return{restrict:"A",scope:{trip:"=",divider:"@",showTimeIcon:"@"},replace:!0,template:'<div class="duration-view"><div class="divider"  ng-if="show_divider">&dash;</div> <div class="icon-container" ng-if="showTimeIcon"> <i class="icon-time muted"></i> </div> <div class="advertised-duration"> <p>{{trip.advertised_duration_string}}</p> </div></div>',controller:["$scope",function(e){e.show_divider=!("false"==e.divider)}]}}]),angular.module("vl.itinerary.common.directives").directive("vlGuaranteedMessaging",[function(){return{restrict:"A",scope:{occurrence:"=",ui_settings:"=uiSettings"},replace:!0,templateUrl:"/store_front/itinerary/bookings/guaranteed-messaging.html",controller:["$scope",function(){}]}}]),angular.module("vl.itinerary.common.directives").directive("vlItineraryDepartureGuaranteedSelector",[function(){return{restrict:"A",scope:!0,replace:!0,templateUrl:"/store_front/itinerary/bookings/departure-guaranteed-selector.html",controller:["$scope",function(e){e.guaranteed_with=0}]}}]),angular.module("vl.itinerary.common.directives").directive("minDepositEnabled",[function(){return{restrict:"A",scope:{occurrence:"=",tripCurrency:"@",tripOption:"="},replace:!0,templateUrl:"/store_front/itinerary/bookings/min-deposit-enabled.html"}}]),angular.module("vl.itinerary.common.directives").directive("minDepositMessage",[function(){return{restrict:"A",scope:{occurrence:"=",payAtVenueEnabled:"@",skipPayment:"@",tripCurrency:"@",paxLabel:"@",tripOption:"="},replace:!0,templateUrl:"/store_front/itinerary/bookings/min-deposit-message.html"}}]),angular.module("vl.itinerary.common.directives").directive("vlNewBookingIcon",function(){return{restrict:"A",replace:!0,template:'<span class="vl-icon-new-booking"><i class="icon-file-alt"></i><i class="icon-plus"></i></span>'}}),angular.module("vl.itinerary.common.directives").directive("vlStartsEndsAtDuration",[function(){return{restrict:"A",scope:{occurrence:"=",trip:"=",show_duration_always:"@showDurationAlways"},replace:!0,templateUrl:"/store_front/itinerary/bookings/starts-ends-at-duration.html",controller:["$scope",function(e){e.show_duration_always=!_.isUndefined(e.show_duration_always)&&"true"==e.show_duration_always,e.date_mismatch=function(e,t){var i=moment(e),n=moment(t);return!(i.isSame(n,"year")&&i.isSame(n,"month")&&i.isSame(n,"day"))}}]}}]),angular.module("vl.itinerary.common.directives").directive("vlStoreFrontBookButton",[function(){return{restrict:"A",scope:{occurrence:"=",trip:"=",trip_option:"=tripOption",onBook:"&"},replace:!0,templateUrl:"/store_front/itinerary/bookings/store-front-book-button.html",controller:["$scope",function(e){e.book_now_clicked=function(t,i,n,r){return e.onBook({trip:t,trip_option:i,starts_at:n,pricings:r})}}]}}]),angular.module("vl.itinerary.common.directives").directive("vlAddonQuantitySelector",["line_item_amountFilter","$timeout",function(e,t){return{restrict:"A",require:"ngModel",template:'<span><span class="addon-quantity-selector"></span><span class="rate visible-phone"> &times; {{addon.amount | line_item_amount : currency }}</span></span>',scope:{addon:"=addon",onChange:"&",select2Opts:"=",currency:"=",pricing:"=",ngModel:"="},link:function(i,n){function r(){var n=[],r=function(t,n){template_str='<span class="pax-quantity-option"><%= option %> <span class="rate muted" style="display: inline;"> &times; <%= rate %></span></span>';var r=_.template(template_str)({option:t.id,rate:e(t.rate,i.currency)});n.append(r)};0!=i.addon.min_units&&n.push({id:0,rate:0});for(var a=i.addon.min_units;a<=i.addon.max_units;a++)n.push({id:a,rate:i.addon.amount});o.select2(angular.extend({formatSelection:r,formatResult:r,initSelection:function(e,t){var i=e.val();t(_.find(n,function(e){return e.id==i}))},data:n,minimumResultsForSearch:10,width:"element",placeholder:"0"},i.select2Opts)),o.bind("change",function(){i.$apply(function(){i.ngModel=parseInt(o.val(),10),i.onChange&&t(function(){i.onChange({value:o.val()})})})}),_.isNumber(i.ngModel)&&i.ngModel>0&&(o.val(i.ngModel),o.change())}var o;t(function(){o=$(n).find("span.addon-quantity-selector"),r()})}}}]),angular.module("vl.itinerary.common.directives").directive("vlCustomerTitleSelector",function(){return{restrict:"A",template:'<select name="title" ng-show="display_title_selector" ng-model="model" ng-required="title_required" class="input-mini customer-title" ng-options="title as title for title in titles"></select>',scope:{optional:"=",model:"="},controller:["$scope","ClientService","TitleService",function(e,t,i){e.titles=i,e.display_title_selector="dont_show"!=t.customer_title_setting,angular.isUndefined(e.optional)||0==e.optional?(console.log("required"),e.title_required="required"==t.customer_title_setting):(console.log("not required"),e.title_required=!1)}]}}),angular.module("vl.itinerary.common.directives").directive("vlPaxQuantitySelector",["line_item_amountFilter","$timeout",function(e,t){return{restrict:"A",require:"ngModel",template:'<span><span class="pax-quantity-selector"></span><span ng-if="pricing.rate_type==\'per_pax\'" class="rate visible-phone"> &times; {{pricing.rate | line_item_amount : currency }}</span><span ng-if="pricing.rate_type==\'group\'" class="slab-pricing-details"><span class="slab-pricing-rate pax" ng-if="show_rate(selectedSlab[1])">&times; {{selectedSlab[1] | line_item_amount : currency}}</span><span class="slab-pricing-rate" ng-if="show_rate(selectedSlab[1]) && show_rate(selectedSlab[2])">+ ( {{selectedSlab[2] | line_item_amount : currency}} )</span><span class="slab-pricing-rate" ng-if="!show_rate(selectedSlab[1]) && show_rate(selectedSlab[2])">{{selectedSlab[2] | line_item_amount : currency}}</span></span></span>',scope:{trip_option:"=tripOption",onChange:"&",select2Opts:"=",currency:"=",pricing:"=",ngModel:"="},link:function(i,n){function r(){var n=[];if("group"==i.pricing.rate_type)var r=i.pricing.slabs,a=0;for(var s=function(t,n){var r=i.show_rate(t.rate),o=i.show_rate(t.group_rate)
;template_str=r&&o?'<span class="pax-quantity-option" data-trip-id="<%= trip_id %>"><%= option %> <span class="rate muted" style="display: inline;"> &times; <%= rate %></span></span>':o?'<span class="pax-quantity-option" data-trip-id="<%= trip_id %>"><%= option %> <span class="rate muted" style="display: inline;"> - <%= group_rate %></span></span>':'<span class="pax-quantity-option" data-trip-id="<%= trip_id %>"><%= option %> <span class="rate muted" style="display: inline;"> &times; <%= rate %></span></span>';var a=_.template(template_str)({option:t.id,trip_id:i.trip_option.trip_id,rate:e(t.rate,i.currency),group_rate:e(t.group_rate,i.currency)});n.append(a)},c=0;c<=(i.trip_option.max_pax||99);c++)"group"==i.pricing.rate_type?(a+1<r.length&&r[a][0]<c&&a++,n.push({id:c,rate:r[a][1],group_rate:r[a][2]})):n.push({id:c,rate:i.pricing.rate});o.select2(angular.extend({formatSelection:s,formatResult:s,initSelection:function(e,t){var i=e.val();t(_.find(n,function(e){return e.id==i}))},data:n,minimumResultsForSearch:100,width:"element",placeholder:"0"},i.select2Opts)),o.bind("change",function(){i.$apply(function(){i.ngModel=parseInt(o.val(),10),"group"==i.pricing.rate_type&&(i.selectedSlab=_.find(i.pricing.slabs,function(e){return e[0]>=i.ngModel})),i.onChange&&t(function(){i.onChange({value:o.val()})})})}),_.isNumber(i.ngModel)&&i.ngModel>0&&(o.val(i.ngModel),o.change())}var o;i.show_rate=function(e){return e&&e>0},t(function(){if(o=$(n).find("span.pax-quantity-selector"),r(),"group"==i.pricing.rate_type)_.find(i.pricing.slabs,function(e){return i.show_rate(e[1])&&i.show_rate(e[2])});else i.delayChange=function(e){i.ngModel=e,i.onChange&&t(function(){i.onChange({value:e})})}})}}}]),angular.module("vl.itinerary.common.directives").directive("vlTripStickerPrice",[function(){return{restrict:"A",scope:{tripOption:"=",currency:"="},replace:!0,templateUrl:"/store_front/itinerary/bookings/trip-sticker-price.html",controller:["$scope",function(){}]}}]),function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.imageFocus={})}(this,function(e){"use strict";function t(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];return t.forEach(function(t){return Object.keys(t).forEach(function(i){return e[i]=t[i]})}),e}function i(e,t){var i;return function(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];clearTimeout(i),i=setTimeout(function(){return e.apply(void 0,n)},t)}}var n={position:"relative",overflow:"hidden"},r={position:"absolute",top:"0",right:"0",bottom:"0",left:"0"},o={display:"block",maxWidth:"100%",touchAction:"none"},a={position:"absolute",cursor:"move",transform:"translate(-50%, -50%)"},s={onChange:function(){},retina:"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgdmlld0JveD0iMCAwIDIwIDIwIj4KICA8ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPgogICAgPGNpcmNsZSBpZD0iYSIgY3g9IjEwIiBjeT0iMTAiIHI9IjEwIiBmaWxsPSIjMDAwIiBmaWxsLW9wYWNpdHk9Ii4zIiAvPgogICAgPGNpcmNsZSBjeD0iMTAiIGN5PSIxMCIgcj0iOSIgc3Ryb2tlPSIjRkZGIiBzdHJva2Utb3BhY2l0eT0iLjgiIHN0cm9rZS13aWR0aD0iMiIvPgogIDwvZz4KPC9zdmc+"},c=function(){function e(e,i){void 0===i&&(i={});var r=this;this.startDragging=function(e){e.preventDefault(),r.isDragging=!0,e instanceof MouseEvent?r.updateCoordinates(e.clientX,e.clientY):r.updateCoordinates(e.touches[0].clientX,e.touches[0].clientY)},this.handleMove=function(e){if(e.preventDefault(),e instanceof MouseEvent)r.updateCoordinates(e.clientX,e.clientY);else{var t=e.touches[0],i=document.elementFromPoint(t.pageX,t.pageY);i!==r.retina&&i!==r.img?r.stopDragging():r.updateCoordinates(t.clientX,t.clientY)}},this.stopDragging=function(){r.isDragging=!1},this.updateRetinaPositionFromFocus=function(){r.updateRetinaPosition(r.calculateOffsetFromFocus())},this.updateRetinaPosition=function(e){r.retina.style.top=e.offsetY+"px",r.retina.style.left=e.offsetX+"px"},this.options=t(s,i),this.img=e,this.container=e.parentElement,this.retina=document.createElement("img"),this.retina.src=this.options.retina,this.retina.draggable=!1,this.container.appendChild(this.retina),this.container.addEventListener("mousedown",this.startDragging),this.container.addEventListener("mousemove",this.handleMove),this.container.addEventListener("mouseup",this.stopDragging),this.container.addEventListener("mouseleave",this.stopDragging),this.container.addEventListener("touchend",this.stopDragging),this.container.addEventListener("touchstart",this.startDragging,{passive:!0}),this.container.addEventListener("touchmove",this.handleMove,{passive:!0}),this.img.draggable=!1,this.img.addEventListener("load",this.updateRetinaPositionFromFocus),t(this.img.style,o),t(this.retina.style,a),t(this.container.style,n),this.focus=this.options.focus?this.options.focus:{x:parseFloat(this.img.getAttribute("data-focus-x"))||0,y:parseFloat(this.img.getAttribute("data-focus-y"))||0},this.setFocus(this.focus)}return e.prototype.setFocus=function(e){this.focus=e,this.img.setAttribute("data-focus-x",e.x.toString()),this.img.setAttribute("data-focus-y",e.y.toString()),this.updateRetinaPositionFromFocus(),this.options.onChange(e)},e.prototype.calculateOffsetFromFocus=function(){var e=this.img.getBoundingClientRect(),t=e.width,i=e.height;return{offsetX:t*(this.focus.x/2+.5),offsetY:i*(this.focus.y/-2+.5)}},e.prototype.updateCoordinates=function(e,t){if(this.isDragging){var i=this.img.getBoundingClientRect(),n=i.width,r=i.height,o=2*((e-i.left)/n-.5),a=-2*((t-i.top)/r-.5);this.setFocus({x:o,y:a})}},e}(),p={minHeight:"100%",minWidth:"100%"},l={height:"100%",width:"100%",border:"none",opacity:0,zIndex:-1,pointerEvents:"none"},u={debounceTime:17,updateOnWindowResize:!0,updateOnContainerResize:!1,containerPosition:"relative"},_=function(){function e(e,o){void 0===o&&(o={});var a=this;this.imageNode=e,this.listening=!1,this.setFocus=function(e){a.focus=e,a.img.setAttribute("data-focus-x",e.x.toString()),a.img.setAttribute("data-focus-y",e.y.toString()),a.applyShift()},this.applyShift=function(){var e=a.img,t=e.naturalWidth,i=e.naturalHeight,n=a.container.getBoundingClientRect(),r=n.width,o=n.height,s="0",c="0";if(!(r>0&&o>0&&t>0&&i>0))return!1;var p=t/r,l=i/o;a.img.style.maxHeight=null,a.img.style.maxWidth=null,t>r&&i>o&&(a.img.style[p>l?"maxHeight":"maxWidth"]="100%"),p>l?s=a.calcShift(l,r,t,a.focus.x)+"%":p<l&&(c=a.calcShift(p,o,i,a.focus.y,!0)+"%"),a.img.style.top=c,a.img.style.left=s},this.options=t(u,o),this.img=e,this.container=e.parentElement,this.img.__focused_image_instance__&&(this.img.__focused_image_instance__.stopListening(),this.img.removeEventListener("load",this.applyShift)),this.img.__focused_image_instance__=this,this.img.addEventListener("load",this.applyShift),t(this.container.style,n),this.container.style.position=this.options.containerPosition,t(this.img.style,p,r),this.debounceApplyShift=i(this.applyShift,this.options.debounceTime),this.focus=this.options.focus?this.options.focus:{x:parseFloat(this.img.getAttribute("data-focus-x"))||0,y:parseFloat(this.img.getAttribute("data-focus-y"))||0},this.startListening(),this.setFocus(this.focus)}return e.prototype.startListening=function(){var e=this;if(!this.listening&&(this.listening=!0,this.options.updateOnWindowResize&&window.addEventListener("resize",this.debounceApplyShift),this.options.updateOnContainerResize)){var i=document.createElement("object");t(i.style,l,r),i.addEventListener("load",function(){return i.contentDocument.defaultView.addEventListener("resize",function(){return e.debounceApplyShift()})}),i.type="text/html",i.setAttribute("aria-hidden","true"),i.tabIndex=-1,this.container.appendChild(i),i.data="about:blank",this.resizeListenerObject=i}},e.prototype.stopListening=function(){this.listening&&(this.listening=!1,window.removeEventListener("resize",this.debounceApplyShift),this.resizeListenerObject&&(this.resizeListenerObject.contentDocument.defaultView.removeEventListener("resize",this.debounceApplyShift),this.container.removeChild(this.resizeListenerObject),this.resizeListenerObject=null))},e.prototype.calcShift=function(e,t,i,n,r){var o=Math.floor(t/2),a=(n+1)/2,s=Math.floor(i/e),c=Math.floor(a*s);r&&(c=s-c);var p=c-o,l=s-c,u=t-o;return l<u&&(p-=u-l),p<0&&(p=0),-100*p/t},e}();e.FocusPicker=c,e.FocusedImage=_,Object.defineProperty(e,"__esModule",{value:!0})}),function(e,t){e.imageFocus=function(e){e.removeAttribute("height"),e.removeAttribute("width"),new imageFocus.FocusedImage(e),e.classList.add("loaded")},e.lazyload=function(e){var t=e.getAttribute("data-src"),i=e.getAttribute("data-srcset");e.setAttribute("srcset",i),e.setAttribute("src",t),e.removeAttribute("data-srcset",i),e.removeAttribute("data-src",t)},e.initLazyLoad=function(){VL.createIntersectionObserver(t("img[data-src]"),function(t){e.lazyload(t),t.classList.contains("focus-image")&&e.imageFocus(t)})},e.initImageFocus=function(){document.querySelectorAll("img:not([data-src]).focus-image").forEach(function(t){e.imageFocus(t)})},VL.init_on_ready("initLazyLoad",e.initLazyLoad)}(window.ASSAN=window.ASSAN||{},jQuery,window),function(e,t,i){t(i.document).ready(function(){e.initLazyLoad(),e.initImageFocus()})}(window.ASSAN=window.ASSAN||{},jQuery,window);